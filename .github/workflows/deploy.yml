name: Deploy Frontend

on:
  push:
    branches:
      - master
      - development
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'master'

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ubuntu

jobs:
  deploy:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Determine branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Sync Frontend Repository on Server
        run: |
          ssh ubuntu@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd ~/hikaweb
            
            # Sync frontend repository
            if [ -d front ]; then
              cd front
              if [ -d .git ]; then
                git fetch origin
                git checkout ${{ steps.branch.outputs.branch }} || git checkout -b ${{ steps.branch.outputs.branch }} origin/${{ steps.branch.outputs.branch }}
                git reset --hard origin/${{ steps.branch.outputs.branch }}
                echo "‚úÖ Frontend repository synced"
              else
                cd ..
                rm -rf front
                git clone -b ${{ steps.branch.outputs.branch }} https://github.com/amirmansour-aghdasy/hikaweb-front.git front
                echo "‚úÖ Frontend repository cloned"
              fi
            else
              git clone -b ${{ steps.branch.outputs.branch }} https://github.com/amirmansour-aghdasy/hikaweb-front.git front
              echo "‚úÖ Frontend repository cloned"
            fi
          EOF

      - name: Deploy Frontend Service
        run: |
          ssh ubuntu@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd ~/hikaweb
            
            # Make sure deploy script is executable
            chmod +x scripts/deploy-service.sh || true
            
            # Deploy frontend
            ./scripts/deploy-service.sh frontend ${{ steps.branch.outputs.branch }}
          EOF

      - name: Verify Deployment
        run: |
          ssh ubuntu@${{ secrets.VPS_HOST }} << 'EOF'
            echo "üîç Verifying frontend deployment..."
            sleep 5
            
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "‚úÖ Frontend is accessible"
            else
              echo "‚ö†Ô∏è  Frontend health check failed, but deployment completed"
            fi
            
            # Show container status
            docker-compose ps frontend
          EOF

